<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microshare ERP Integration - Dashboard</title>
    <style>
        /* Clean, functional dashboard styling */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo h1 {
            color: #333;
            font-size: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .search-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 120px;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .device-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .device-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .device-type-rodent {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .device-type-gateway {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .erp-ready {
            color: #28a745;
            font-weight: 500;
        }
        
        .erp-not-ready {
            color: #dc3545;
            font-weight: 500;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        
        .close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group small {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }
        
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-filters,
            .actions {
                justify-content: center;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>üîó Microshare ERP Integration</h1>
            </div>
            <div class="user-info">
                <span id="userInfo">Loading...</span>
                <a href="/import.html" class="btn btn-secondary">üìÅ Import CSV</a>
                <button id="logoutBtn" class="btn btn-danger">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Statistics -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-number" id="totalDevices">-</div>
                <div class="stat-label">Total Devices</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rodentSensors">-</div>
                <div class="stat-label">Rodent Sensors</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="gateways">-</div>
                <div class="stat-label">Gateways</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="erpReady">-</div>
                <div class="stat-label">ERP Ready</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-row">
                <div class="search-filters">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search devices...">
                    <select id="customerFilter" class="filter-select">
                        <option value="">All Customers</option>
                    </select>
                    <select id="typeFilter" class="filter-select">
                        <option value="">All Types</option>
                        <option value="rodent_sensor">Rodent Sensors</option>
                        <option value="gateway">Gateways</option>
                    </select>
                </div>
                <div class="actions">
                    <button id="refreshBtn" class="btn btn-primary">üîÑ Refresh</button>
                    <button id="addDeviceBtn" class="btn btn-success">‚ûï Add Device</button>
                    <button id="exportBtn" class="btn btn-secondary">üì§ Export CSV</button>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Device Table -->
        <div class="device-table">
            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                Loading devices from Microshare...
            </div>
            
            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>No devices found</h3>
                <p>Add your first device or adjust your search filters</p>
            </div>
            
            <table id="deviceTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Device ID</th>
                        <th>Customer</th>
                        <th>Site</th>
                        <th>Area</th>
                        <th>ERP Reference</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>ERP Ready</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="deviceTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Device Modal -->
    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Device</h3>
                <span class="close">&times;</span>
            </div>
            
            <div id="modalAlert"></div>
            
            <form id="deviceForm">
                <div class="form-group">
                    <label for="customerInput">Customer *</label>
                    <input type="text" id="customerInput" name="customer" required>
                    <small>Organization or customer name</small>
                </div>
                
                <div class="form-group">
                    <label for="siteInput">Site *</label>
                    <input type="text" id="siteInput" name="site" required>
                    <small>Facility or location name</small>
                </div>
                
                <div class="form-group">
                    <label for="areaInput">Area *</label>
                    <input type="text" id="areaInput" name="area" required>
                    <small>Specific area or zone within the site</small>
                </div>
                
                <div class="form-group">
                    <label for="erpReferenceInput">ERP Reference *</label>
                    <input type="text" id="erpReferenceInput" name="erp_reference" required>
                    <small>Internal ERP system reference (critical for sync)</small>
                </div>
                
                <div class="form-group">
                    <label for="placementInput">Placement</label>
                    <select id="placementInput" name="placement">
                        <option value="Internal">Internal</option>
                        <option value="External">External</option>
                    </select>
                    <small>Device placement location</small>
                </div>
                
                <div class="form-group">
                    <label for="configurationInput">Configuration</label>
                    <select id="configurationInput" name="configuration">
                        <option value="Bait/Lured">Bait/Lured</option>
                        <option value="Poison">Poison</option>
                        <option value="Kill/Trap">Kill/Trap</option>
                        <option value="Glue">Glue</option>
                        <option value="Cavity">Cavity</option>
                    </select>
                    <small>Device configuration type</small>
                </div>
                
                <div class="form-group">
                    <label for="deviceTypeInput">Device Type</label>
                    <select id="deviceTypeInput" name="device_type">
                        <option value="rodent_sensor">Rodent Sensor</option>
                        <option value="gateway">Gateway</option>
                    </select>
                    <small>Type of device being added</small>
                </div>
                
                <div class="form-group">
                    <label for="statusInput">Status</label>
                    <select id="statusInput" name="status">
                        <option value="pending">Pending</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                    <small>Current device status</small>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-success" id="saveBtn">Save Device</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================================
        // DASHBOARD CONTROLLER (Canonical API Patterns)
        // ============================================================
        
        class DashboardController {
            constructor() {
                this.baseURL = 'http://10.35.1.62:8000';
                this.sessionToken = localStorage.getItem('microshare_session_token');
                this.devices = [];
                this.filteredDevices = [];
                
                // Check authentication
                if (!this.sessionToken) {
                    this.redirectToLogin();
                    return;
                }
                
                this.initializeEventListeners();
                this.loadUserInfo();
                this.loadDevices();
            }
            
            redirectToLogin() {
                window.location.href = '/index.html';
            }
            
            async makeAuthenticatedRequest(url, options = {}) {
                const headers = {
                    'Authorization': `Bearer ${this.sessionToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                try {
                    const response = await fetch(url, { ...options, headers });
                    
                    if (response.status === 401) {
                        this.showAlert('Session expired. Please log in again.', 'error');
                        this.logout();
                        return null;
                    }
                    
                    return response;
                } catch (error) {
                    this.showAlert(`Network error: ${error.message}`, 'error');
                    return null;
                }
            }
            
            loadUserInfo() {
                const userInfo = localStorage.getItem('user_info');
                if (userInfo) {
                    const info = JSON.parse(userInfo);
                    document.getElementById('userInfo').textContent = `${info.username} (${info.environment})`;
                }
            }
            
            async loadDevices() {
                this.showLoading(true);
                
                try {
                    const response = await this.makeAuthenticatedRequest(
                        `${this.baseURL}/api/v1/devices`
                    );
                    
                    if (response && response.ok) {
                        const result = await response.json();
                        this.devices = result.devices;
                        this.filteredDevices = [...this.devices];
                        
                        this.updateStatistics();
                        this.populateFilters();
                        this.renderDeviceTable();
                        this.showAlert(`Loaded ${result.total_count} devices successfully`, 'success');
                    } else {
                        throw new Error('Failed to load devices');
                    }
                } catch (error) {
                    this.showAlert(`Failed to load devices: ${error.message}`, 'error');
                    this.devices = [];
                    this.filteredDevices = [];
                    this.updateStatistics();
                }
                
                this.showLoading(false);
            }
            
            updateStatistics() {
                const total = this.devices.length;
                const rodentSensors = this.devices.filter(d => d.device_type === 'rodent_sensor').length;
                const gateways = this.devices.filter(d => d.device_type === 'gateway').length;
                const erpReady = this.devices.filter(d => d.erp_ready).length;
                
                document.getElementById('totalDevices').textContent = total;
                document.getElementById('rodentSensors').textContent = rodentSensors;
                document.getElementById('gateways').textContent = gateways;
                document.getElementById('erpReady').textContent = erpReady;
            }
            
            populateFilters() {
                const customerFilter = document.getElementById('customerFilter');
                const customers = [...new Set(this.devices.map(d => d.customer).filter(c => c))];
                
                // Clear existing options (except "All Customers")
                customerFilter.innerHTML = '<option value="">All Customers</option>';
                
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer;
                    option.textContent = customer;
                    customerFilter.appendChild(option);
                });
            }
            
            renderDeviceTable() {
                const tableBody = document.getElementById('deviceTableBody');
                const table = document.getElementById('deviceTable');
                const emptyState = document.getElementById('emptyState');
                
                if (this.filteredDevices.length === 0) {
                    table.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }
                
                table.style.display = 'table';
                emptyState.style.display = 'none';
                
                tableBody.innerHTML = this.filteredDevices.map(device => `
                    <tr>
                        <td>${device.id}</td>
                        <td>${device.customer}</td>
                        <td>${device.site}</td>
                        <td>${device.area}</td>
                        <td>${device.erp_reference}</td>
                        <td>
                            <span class="device-type device-type-${device.device_type.replace('_', '-')}">
                                ${device.device_type === 'rodent_sensor' ? 'Rodent Sensor' : 'Gateway'}
                            </span>
                        </td>
                        <td>
                            <span class="status status-${device.status}">
                                ${device.status.charAt(0).toUpperCase() + device.status.slice(1)}
                            </span>
                        </td>
                        <td>
                            <span class="${device.erp_ready ? 'erp-ready' : 'erp-not-ready'}">
                                ${device.erp_ready ? '‚úì Ready' : '‚úó Not Ready'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary" onclick="dashboard.viewDevice('${device.id}')">View</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            applyFilters() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const customerFilter = document.getElementById('customerFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                
                this.filteredDevices = this.devices.filter(device => {
                    const matchesSearch = !searchTerm || 
                        device.id.toLowerCase().includes(searchTerm) ||
                        device.customer.toLowerCase().includes(searchTerm) ||
                        device.site.toLowerCase().includes(searchTerm) ||
                        device.area.toLowerCase().includes(searchTerm) ||
                        device.erp_reference.toLowerCase().includes(searchTerm);
                    
                    const matchesCustomer = !customerFilter || device.customer === customerFilter;
                    const matchesType = !typeFilter || device.device_type === typeFilter;
                    
                    return matchesSearch && matchesCustomer && matchesType;
                });
                
                this.renderDeviceTable();
            }
            
            async createDevice(deviceData) {
                try {
                    const response = await this.makeAuthenticatedRequest(
                        `${this.baseURL}/api/v1/devices`,
                        {
                            method: 'POST',
                            body: JSON.stringify(deviceData)
                        }
                    );
                    
                    if (response && response.ok) {
                        const result = await response.json();
                        this.showAlert('Device created successfully!', 'success');
                        this.closeModal();
                        this.loadDevices(); // Reload to get updated data
                        return result;
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to create device');
                    }
                } catch (error) {
                    this.showAlert(`Failed to create device: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            async exportDevices() {
                try {
                    const response = await this.makeAuthenticatedRequest(
                        `${this.baseURL}/api/v1/devices/export`
                    );
                    
                    if (response && response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = 'microshare_devices.csv';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        this.showAlert('Devices exported successfully!', 'success');
                    } else {
                        throw new Error('Failed to export devices');
                    }
                } catch (error) {
                    this.showAlert(`Export failed: ${error.message}`, 'error');
                }
            }
            
            viewDevice(deviceId) {
                const device = this.devices.find(d => d.id === deviceId);
                if (device) {
                    alert(`Device Details:\n\nID: ${device.id}\nCustomer: ${device.customer}\nSite: ${device.site}\nArea: ${device.area}\nERP Reference: ${device.erp_reference}\nType: ${device.device_type}\nStatus: ${device.status}\nERP Ready: ${device.erp_ready ? 'Yes' : 'No'}`);
                }
            }
            
            showLoading(show) {
                const loadingState = document.getElementById('loadingState');
                const table = document.getElementById('deviceTable');
                const emptyState = document.getElementById('emptyState');
                
                if (show) {
                    loadingState.style.display = 'block';
                    table.style.display = 'none';
                    emptyState.style.display = 'none';
                } else {
                    loadingState.style.display = 'none';
                }
            }
            
            showAlert(message, type = 'error') {
                const alertContainer = document.getElementById('alertContainer');
                alertContainer.innerHTML = `
                    <div class="alert alert-${type}">
                        ${message}
                    </div>
                `;
                
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 5000);
            }
            
            showModal() {
                document.getElementById('deviceModal').style.display = 'block';
            }
            
            closeModal() {
                document.getElementById('deviceModal').style.display = 'none';
                document.getElementById('deviceForm').reset();
                document.getElementById('modalAlert').innerHTML = '';
            }
            
            logout() {
                localStorage.removeItem('microshare_session_token');
                localStorage.removeItem('user_info');
                localStorage.removeItem('api_base');
                this.redirectToLogin();
            }
            
            initializeEventListeners() {
                // Search and filters
                document.getElementById('searchInput').addEventListener('input', () => this.applyFilters());
                document.getElementById('customerFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('typeFilter').addEventListener('change', () => this.applyFilters());
                
                // Action buttons
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadDevices());
                document.getElementById('addDeviceBtn').addEventListener('click', () => this.showModal());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportDevices());
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                
                // Modal controls
                document.querySelector('.close').addEventListener('click', () => this.closeModal());
                document.getElementById('cancelBtn').addEventListener('click', () => this.closeModal());
                
                // Form submission
                document.getElementById('deviceForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const deviceData = Object.fromEntries(formData.entries());
                    
                    try {
                        await this.createDevice(deviceData);
                    } catch (error) {
                        // Error already handled in createDevice method
                    }
                });
                
                // Close modal when clicking outside
                window.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('deviceModal')) {
                        this.closeModal();
                    }
                });
            }
        }
        
        // Initialize dashboard
        const dashboard = new DashboardController();
    </script>
</body>
</html>
