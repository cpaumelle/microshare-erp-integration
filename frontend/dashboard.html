<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microshare ERP Integration - Dashboard v3.0 (Optimized)</title>
    <style>
        /* Clean, functional dashboard styling */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo h1 {
            color: #333;
            font-size: 20px;
            margin-bottom: 4px;
        }

        .performance-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            transition: all 0.2s;
            margin-right: 5px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .search-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 120px;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .device-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .device-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .device-type-rodent {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .device-type-gateway {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .erp-ready {
            color: #28a745;
            font-weight: 500;
        }
        
        .erp-not-ready {
            color: #dc3545;
            font-weight: 500;
        }

        .device-deleting {
            text-decoration: line-through;
            opacity: 0.6;
            background-color: #f8f9fa !important;
        }

        .device-deleting td {
            color: #6c757d !important;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        
        .close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group small {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }
        
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-filters,
            .actions {
                justify-content: center;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>🚀 Microshare ERP Integration v3.0</h1>
                <div class="performance-badge">⚡ 45x Faster CRUD Operations</div>
                <small id="build-info" style="color: #666; display: block; margin-top: 4px;">Build: v3.0.1 | 2025-09-15 14:05 | Cache-Busted</small>
            </div>
            <div class="user-info">
                <span id="userInfo">Loading...</span>
                <a href="/import.html" class="btn btn-secondary">📁 Import CSV</a>
                <button id="logoutBtn" class="btn btn-danger">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Statistics -->
        <div class="dashboard-stats">
            <div class="stat-card" data-filter-type="all">
                <div class="stat-number" id="totalDevices">-</div>
                <div class="stat-label">Total Devices</div>
            </div>
            <div class="stat-card" data-filter-type="rodent_sensor">
                <div class="stat-number" id="rodentSensors">-</div>
                <div class="stat-label">Rodent Sensors</div>
            </div>
            <div class="stat-card" data-filter-type="gateway">
                <div class="stat-number" id="gateways">-</div>
                <div class="stat-label">Gateways</div>
            </div>
            <div class="stat-card" data-filter-type="erp_ready">
                <div class="stat-number" id="erpReady">-</div>
                <div class="stat-label">ERP Ready</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-row">
                <div class="search-filters">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search devices...">
                    <select id="customerFilter" class="filter-select">
                        <option value="">All Customers</option>
                    </select>
                    <select id="typeFilter" class="filter-select">
                        <option value="">All Types</option>
                        <option value="rodent_sensor">Rodent Sensors</option>
                        <option value="gateway">Gateways</option>
                    </select>
                </div>
                <div class="actions">
                    <button id="refreshBtn" class="btn btn-primary">🔄 Refresh</button>
                    <button id="addDeviceBtn" class="btn btn-success">➕ Add Device</button>
                    <button id="exportBtn" class="btn btn-secondary">📤 Export CSV</button>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Device Table -->
        <div class="device-table">
            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                <div>Loading devices from Microshare...</div>
                <small style="opacity: 0.8; margin-top: 8px; display: block; font-size: 12px;">
                    May take 20-30 seconds on first load but should be faster afterwards
                </small>
            </div>
            
            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>No devices found</h3>
                <p>Add your first device or adjust your search filters</p>
            </div>
            
            <table id="deviceTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Device ID</th>
                        <th>Customer</th>
                        <th>Site</th>
                        <th>Area</th>
                        <th>ERP Reference</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>ERP Ready</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="deviceTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit Device Modal -->
    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Device</h3>
                <span class="close">&times;</span>
            </div>

            <div id="modalAlert"></div>

            <form id="deviceForm">
                <input type="hidden" id="deviceIdHidden" name="device_id">
                <div class="form-group">
                    <label for="customerInput">Customer *</label>
                    <input type="text" id="customerInput" name="customer" required>
                    <small>Organization or customer name</small>
                </div>
                
                <div class="form-group">
                    <label for="siteInput">Site *</label>
                    <input type="text" id="siteInput" name="site" required>
                    <small>Facility or location name</small>
                </div>
                
                <div class="form-group">
                    <label for="areaInput">Area *</label>
                    <input type="text" id="areaInput" name="area" required>
                    <small>Specific area or zone within the site</small>
                </div>
                
                <div class="form-group">
                    <label for="erpReferenceInput">ERP Reference *</label>
                    <input type="text" id="erpReferenceInput" name="erp_reference" required>
                    <small>Internal ERP system reference (critical for sync)</small>
                </div>
                
                <div class="form-group">
                    <label for="placementInput">Placement</label>
                    <select id="placementInput" name="placement">
                        <option value="Internal">Internal</option>
                        <option value="External">External</option>
                    </select>
                    <small>Device placement location</small>
                </div>
                
                <div class="form-group">
                    <label for="configurationInput">Configuration</label>
                    <select id="configurationInput" name="configuration">
                        <option value="Bait/Lured">Bait/Lured</option>
                        <option value="Poison">Poison</option>
                        <option value="Kill/Trap">Kill/Trap</option>
                        <option value="Glue">Glue</option>
                        <option value="Cavity">Cavity</option>
                    </select>
                    <small>Device configuration type</small>
                </div>
                
                <div class="form-group">
                    <label for="deviceTypeInput">Device Type</label>
                    <select id="deviceTypeInput" name="device_type">
                        <option value="rodent_sensor">Rodent Sensor</option>
                        <option value="gateway">Gateway</option>
                    </select>
                    <small>Type of device being added</small>
                </div>
                
                <div class="form-group">
                    <label for="statusInput">Status</label>
                    <select id="statusInput" name="status">
                        <option value="pending">Pending</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                    <small>Current device status</small>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-success" id="saveBtn">Save Device</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Device Details Modal -->
    <div id="deviceDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Device Details</h3>
                <span class="close" onclick="dashboard.closeDetailsModal()">&times;</span>
            </div>

            <div id="deviceDetailsContent">
                <!-- Device details will be populated here -->
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="dashboard.closeDetailsModal()">Close</button>
                <button type="button" class="btn btn-primary" id="editFromDetailsBtn">Edit Device</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <span class="close" onclick="dashboard.closeDeleteModal()">&times;</span>
            </div>

            <p>Are you sure you want to delete this device?</p>
            <div id="deleteDeviceInfo"></div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="dashboard.closeDeleteModal()">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Device</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // VERSION INFO - IMMEDIATE CONSOLE OUTPUT
        // ============================================================
        console.log(`%c🚀 MICROSHARE ERP INTEGRATION DASHBOARD`, 'background: #28a745; color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold; font-size: 16px;');
        console.log(`%c📦 Version: 3.0.1 | Build: 2025-09-15T14:05:00Z`, 'color: #007bff; font-weight: bold; font-size: 14px;');
        console.log(`%c⚡ Cache busting enabled - You're running the latest code!`, 'color: #28a745; font-weight: bold;');
        console.log(`%c🔧 CRUD Performance: Frontend optimizations active`, 'color: #17a2b8; font-weight: bold;');

        // ============================================================
        // DASHBOARD CONTROLLER (Canonical API Patterns)
        // ============================================================
        
        class DashboardController {
            constructor() {
                this.baseURL = 'http://10.35.1.62:8000';
                this.sessionToken = localStorage.getItem('microshare_session_token');
                this.devices = [];
                this.filteredDevices = [];
                this.editingDeviceId = null;
                this.deletingDeviceId = null;
                this.devicesBeingDeleted = new Set(); // Track devices being deleted for visual feedback

                // Check authentication
                if (!this.sessionToken) {
                    this.redirectToLogin();
                    return;
                }

                this.initializeEventListeners();
                this.loadUserInfo();
                this.loadDevices();
            }
            
            redirectToLogin() {
                window.location.href = '/index.html';
            }
            
            async makeAuthenticatedRequest(url, options = {}) {
                const headers = {
                    'Authorization': `Bearer ${this.sessionToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                try {
                    const response = await fetch(url, { ...options, headers });
                    
                    if (response.status === 401) {
                        this.showAlert('Session expired. Please log in again.', 'error');
                        this.logout();
                        return null;
                    }
                    
                    return response;
                } catch (error) {
                    this.showAlert(`Network error: ${error.message}`, 'error');
                    return null;
                }
            }
            
            loadUserInfo() {
                const userInfo = localStorage.getItem('user_info');
                if (userInfo) {
                    const info = JSON.parse(userInfo);
                    document.getElementById('userInfo').textContent = `${info.username} (${info.environment})`;
                }
            }
            
            async loadDevices() {
                this.showLoading(true);
                
                try {
                    const response = await this.makeAuthenticatedRequest(
                        `${this.baseURL}/api/v1/devices`
                    );
                    
                    if (response && response.ok) {
                        const result = await response.json();
                        this.devices = result.devices;
                        this.filteredDevices = [...this.devices];
                        
                        this.updateStatistics();
                        this.populateFilters();
                        this.renderDeviceTable();
                        this.showAlert(`Loaded ${result.total_count} devices successfully`, 'success');
                    } else {
                        throw new Error('Failed to load devices');
                    }
                } catch (error) {
                    this.showAlert(`Failed to load devices: ${error.message}`, 'error');
                    this.devices = [];
                    this.filteredDevices = [];
                    this.updateStatistics();
                }
                
                this.showLoading(false);
            }
            
            updateStatistics() {
                const total = this.devices.length;
                const rodentSensors = this.devices.filter(d => d.device_type === 'rodent_sensor').length;
                const gateways = this.devices.filter(d => d.device_type === 'gateway').length;
                const erpReady = this.devices.filter(d => d.erp_ready).length;
                
                document.getElementById('totalDevices').textContent = total;
                document.getElementById('rodentSensors').textContent = rodentSensors;
                document.getElementById('gateways').textContent = gateways;
                document.getElementById('erpReady').textContent = erpReady;
            }
            
            populateFilters() {
                const customerFilter = document.getElementById('customerFilter');
                const customers = [...new Set(this.devices.map(d => d.customer).filter(c => c))];
                
                // Clear existing options (except "All Customers")
                customerFilter.innerHTML = '<option value="">All Customers</option>';
                
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer;
                    option.textContent = customer;
                    customerFilter.appendChild(option);
                });
            }
            
            renderDeviceTable() {
                const tableBody = document.getElementById('deviceTableBody');
                const table = document.getElementById('deviceTable');
                const emptyState = document.getElementById('emptyState');
                
                if (this.filteredDevices.length === 0) {
                    table.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }
                
                table.style.display = 'table';
                emptyState.style.display = 'none';
                
                tableBody.innerHTML = this.filteredDevices.map(device => {
                    const isBeingDeleted = this.devicesBeingDeleted.has(device.id);
                    const rowClass = isBeingDeleted ? 'device-deleting' : '';

                    return `
                    <tr class="${rowClass}">
                        <td>${device.id}</td>
                        <td>${device.customer}</td>
                        <td>${device.site}</td>
                        <td>${device.area}</td>
                        <td>${device.erp_reference}</td>
                        <td>
                            <span class="device-type device-type-${device.device_type.replace('_', '-')}">
                                ${device.device_type === 'rodent_sensor' ? 'Rodent Sensor' : 'Gateway'}
                            </span>
                        </td>
                        <td>
                            <span class="status status-${device.status}">
                                ${device.status.charAt(0).toUpperCase() + device.status.slice(1)}
                            </span>
                        </td>
                        <td>
                            <span class="${device.erp_ready ? 'erp-ready' : 'erp-not-ready'}">
                                ${device.erp_ready ? '✓ Ready' : '✗ Not Ready'}
                            </span>
                        </td>
                        <td>
                            ${isBeingDeleted ?
                                '<span style="color: #6c757d; font-style: italic;">Deleting...</span>' :
                                `<button class="btn btn-primary" onclick="dashboard.viewDeviceDetails('${device.guid || device.id}')">👁️ View</button>
                                 <button class="btn btn-secondary" onclick="dashboard.editDevice('${device.guid || device.id}')">✏️ Edit</button>
                                 <button class="btn btn-danger" onclick="dashboard.deleteDevice('${device.guid || device.id}')">🗑️ Delete</button>`
                            }
                        </td>
                    </tr>
                `;
                }).join('');
            }
            
            applyStatCardFilter(filterType) {
                // Clear existing filters
                document.getElementById('searchInput').value = '';
                document.getElementById('customerFilter').value = '';
                document.getElementById('typeFilter').value = '';

                // Apply the stat card filter
                switch (filterType) {
                    case 'all':
                        this.filteredDevices = [...this.devices];
                        break;
                    case 'rodent_sensor':
                        document.getElementById('typeFilter').value = 'rodent_sensor';
                        this.filteredDevices = this.devices.filter(d => d.device_type === 'rodent_sensor');
                        break;
                    case 'gateway':
                        document.getElementById('typeFilter').value = 'gateway';
                        this.filteredDevices = this.devices.filter(d => d.device_type === 'gateway');
                        break;
                    case 'erp_ready':
                        this.filteredDevices = this.devices.filter(d => d.erp_ready === true);
                        break;
                }

                this.renderDeviceTable();
            }

            applyFilters() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const customerFilter = document.getElementById('customerFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;

                this.filteredDevices = this.devices.filter(device => {
                    const matchesSearch = !searchTerm ||
                        device.id.toLowerCase().includes(searchTerm) ||
                        device.customer.toLowerCase().includes(searchTerm) ||
                        device.site.toLowerCase().includes(searchTerm) ||
                        device.area.toLowerCase().includes(searchTerm) ||
                        device.erp_reference.toLowerCase().includes(searchTerm);

                    const matchesCustomer = !customerFilter || device.customer === customerFilter;
                    const matchesType = !typeFilter || device.device_type === typeFilter;

                    return matchesSearch && matchesCustomer && matchesType;
                });

                this.renderDeviceTable();
            }
            
            async saveDevice(deviceData) {
                try {
                    const startTime = performance.now();
                    const isEditing = this.editingDeviceId !== null;
                    const url = isEditing
                        ? `${this.baseURL}/api/v1/devices/${this.editingDeviceId}`
                        : `${this.baseURL}/api/v1/devices/create`;
                    const method = isEditing ? 'PUT' : 'POST';

                    const response = await this.makeAuthenticatedRequest(url, {
                        method,
                        body: JSON.stringify(deviceData)
                    });

                    if (response && response.ok) {
                        const result = await response.json();
                        const duration = ((performance.now() - startTime) / 1000).toFixed(2);

                        if (result.success) {
                            const action = isEditing ? 'updated' : 'created';
                            const improvement = result.performance_metrics ? result.performance_metrics.improvement_factor : '';
                            this.showAlert(`✅ Device ${action} successfully in ${duration}s! ${improvement}`, 'success');
                            this.closeModal();

                            // Update local state instead of full reload for faster performance
                            this.editingDeviceId = null;

                            // Update the device in local array if editing, or add if creating
                            if (isEditing && result.device) {
                                const deviceIndex = this.devices.findIndex(d => d.id === result.device.id || d.guid === result.device.guid);
                                if (deviceIndex !== -1) {
                                    this.devices[deviceIndex] = result.device;
                                }
                            } else if (result.device) {
                                this.devices.push(result.device);
                            }

                            // Re-render the display without API call
                            this.renderDevices();
                        } else {
                            this.showAlert(`Failed to ${isEditing ? 'update' : 'create'} device: ${result.message}`, 'error');
                        }
                        return result;
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `Failed to ${isEditing ? 'update' : 'create'} device`);
                    }
                } catch (error) {
                    const action = this.editingDeviceId ? 'update' : 'create';
                    this.showAlert(`Failed to ${action} device: ${error.message}`, 'error');
                    throw error;
                }
            }

            updateDeviceInMemory(deviceId, updatedData) {
                console.log('=== UPDATE DEVICE IN MEMORY DEBUG ===');
                console.log('deviceId:', deviceId);
                console.log('updatedData:', updatedData);
                console.log('Current devices array length:', this.devices.length);

                // Find and update the device in the local arrays
                const deviceIndex = this.devices.findIndex(d => d.id === deviceId);
                console.log('Device index found:', deviceIndex);

                if (deviceIndex !== -1) {
                    console.log('Original device:', this.devices[deviceIndex]);

                    // Update the device with new data, preserving existing fields
                    this.devices[deviceIndex] = { ...this.devices[deviceIndex], ...updatedData };
                    console.log('Updated device:', this.devices[deviceIndex]);

                    // Update filtered devices too
                    const filteredIndex = this.filteredDevices.findIndex(d => d.id === deviceId);
                    console.log('Filtered device index found:', filteredIndex);

                    if (filteredIndex !== -1) {
                        this.filteredDevices[filteredIndex] = { ...this.filteredDevices[filteredIndex], ...updatedData };
                        console.log('Updated filtered device:', this.filteredDevices[filteredIndex]);
                    }

                    console.log('About to re-render table and update stats...');
                    // Re-render the table with updated data
                    this.renderDeviceTable();
                    this.updateStatistics();
                    console.log('Table re-rendered and stats updated');
                } else {
                    console.error('Device not found in memory:', deviceId);
                }
            }
            
            async exportDevices() {
                try {
                    const response = await this.makeAuthenticatedRequest(
                        `${this.baseURL}/api/v1/devices/export`
                    );
                    
                    if (response && response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = 'microshare_devices.csv';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        this.showAlert('Devices exported successfully!', 'success');
                    } else {
                        throw new Error('Failed to export devices');
                    }
                } catch (error) {
                    this.showAlert(`Export failed: ${error.message}`, 'error');
                }
            }
            
            async viewDeviceDetails(deviceKey) {
                try {
                    const response = await this.makeAuthenticatedRequest(
                        `${this.baseURL}/api/v1/devices/${deviceKey}`
                    );

                    if (response && response.ok) {
                        const result = await response.json();
                        this.showDeviceDetails(result.device, result.cluster_info);
                    } else {
                        throw new Error('Failed to load device details');
                    }
                } catch (error) {
                    this.showAlert(`Failed to load device details: ${error.message}`, 'error');
                }
            }

            showDeviceDetails(device, clusterInfo) {
                const detailsContent = document.getElementById('deviceDetailsContent');
                detailsContent.innerHTML = `
                    <div class="device-details">
                        <div class="detail-section">
                            <h4>Device Information</h4>
                            <div class="detail-grid">
                                <div><strong>Device ID:</strong> ${device.id}</div>
                                <div><strong>Customer:</strong> ${device.customer}</div>
                                <div><strong>Site:</strong> ${device.site}</div>
                                <div><strong>Area:</strong> ${device.area}</div>
                                <div><strong>ERP Reference:</strong> ${device.erp_reference}</div>
                                <div><strong>Device Type:</strong> ${device.device_type === 'rodent_sensor' ? 'Rodent Sensor' : 'Gateway'}</div>
                                <div><strong>Status:</strong> <span class="status status-${device.status}">${device.status}</span></div>
                                <div><strong>ERP Ready:</strong> <span class="${device.erp_ready ? 'erp-ready' : 'erp-not-ready'}">${device.erp_ready ? '✓ Ready' : '✗ Not Ready'}</span></div>
                                <div><strong>Placement:</strong> ${device.placement || 'N/A'}</div>
                                <div><strong>Configuration:</strong> ${device.configuration || 'N/A'}</div>
                            </div>
                        </div>
                        ${clusterInfo ? `
                            <div class="detail-section">
                                <h4>Cluster Information</h4>
                                <div class="detail-grid">
                                    <div><strong>Cluster Name:</strong> ${clusterInfo.name || 'N/A'}</div>
                                    <div><strong>Cluster Type:</strong> ${clusterInfo.type || 'N/A'}</div>
                                    <div><strong>Device Count:</strong> ${clusterInfo.device_count || 'N/A'}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <style>
                        .detail-section { margin-bottom: 20px; }
                        .detail-section h4 { margin-bottom: 10px; color: #333; }
                        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                        .detail-grid > div { padding: 8px 0; border-bottom: 1px solid #eee; }
                    </style>
                `;

                document.getElementById('editFromDetailsBtn').onclick = () => {
                    this.closeDetailsModal();
                    this.editDevice(device.guid || device.id);
                };

                document.getElementById('deviceDetailsModal').style.display = 'block';
            }

            editDevice(deviceKey) {
                // Use GUID for identification, fall back to ID
                const device = this.devices.find(d => (d.guid && d.guid === deviceKey) || d.id === deviceKey);
                if (!device) {
                    this.showAlert('Device not found', 'error');
                    return;
                }

                this.editingDeviceId = deviceKey;

                // Populate form with device data
                document.getElementById('modalTitle').textContent = 'Edit Device';
                document.getElementById('deviceIdHidden').value = deviceKey;
                document.getElementById('customerInput').value = device.customer || '';
                document.getElementById('siteInput').value = device.site || '';
                document.getElementById('areaInput').value = device.area || '';
                document.getElementById('erpReferenceInput').value = device.erp_reference || '';
                document.getElementById('placementInput').value = device.placement || 'Internal';
                document.getElementById('configurationInput').value = device.configuration || 'Bait/Lured';
                document.getElementById('deviceTypeInput').value = device.device_type || 'rodent_sensor';
                document.getElementById('statusInput').value = device.status || 'pending';

                document.getElementById('saveBtn').textContent = 'Update Device';
                this.showModal();
            }

            deleteDevice(deviceKey) {
                // Use GUID for identification, fall back to ID
                const device = this.devices.find(d => (d.guid && d.guid === deviceKey) || d.id === deviceKey);
                if (!device) {
                    this.showAlert('Device not found', 'error');
                    return;
                }

                this.deletingDeviceId = deviceKey;

                document.getElementById('deleteDeviceInfo').innerHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 15px 0;">
                        <strong>Device:</strong> ${device.id}<br>
                        <strong>Customer:</strong> ${device.customer}<br>
                        <strong>Site:</strong> ${device.site}<br>
                        <strong>Area:</strong> ${device.area}
                    </div>
                `;

                document.getElementById('confirmDeleteBtn').onclick = () => this.confirmDelete();
                document.getElementById('deleteConfirmModal').style.display = 'block';
            }

            async confirmDelete() {
                if (!this.deletingDeviceId) return;

                try {
                    const startTime = performance.now();
                    const response = await this.makeAuthenticatedRequest(
                        `${this.baseURL}/api/v1/devices/${this.deletingDeviceId}`,
                        { method: 'DELETE' }
                    );

                    if (response && response.ok) {
                        const result = await response.json();

                        if (result.success) {
                            const duration = ((performance.now() - startTime) / 1000).toFixed(2);
                            const improvement = result.performance_metrics ? result.performance_metrics.improvement_factor : '';
                            this.showAlert(`✅ Device deleted successfully in ${duration}s! ${improvement}`, 'success');
                            this.closeDeleteModal();

                            // Remove from local state instead of full reload for faster performance
                            this.devices = this.devices.filter(d => d.id !== this.deletingDeviceId && d.guid !== this.deletingDeviceId);
                            this.renderDevices();
                        } else {
                            this.showAlert(`Failed to delete device: ${result.message}`, 'error');
                        }
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to delete device');
                    }
                } catch (error) {
                    this.showAlert(`Failed to delete device: ${error.message}`, 'error');
                }
            }
            
            showLoading(show) {
                const loadingState = document.getElementById('loadingState');
                const table = document.getElementById('deviceTable');
                const emptyState = document.getElementById('emptyState');
                
                if (show) {
                    loadingState.style.display = 'block';
                    table.style.display = 'none';
                    emptyState.style.display = 'none';
                } else {
                    loadingState.style.display = 'none';
                }
            }
            
            showAlert(message, type = 'error') {
                const alertContainer = document.getElementById('alertContainer');
                alertContainer.innerHTML = `
                    <div class="alert alert-${type}">
                        ${message}
                    </div>
                `;
                
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 5000);
            }
            
            showAddDeviceModal() {
                this.editingDeviceId = null;
                document.getElementById('modalTitle').textContent = 'Add New Device';
                document.getElementById('saveBtn').textContent = 'Save Device';
                document.getElementById('deviceForm').reset();
                document.getElementById('deviceIdHidden').value = '';
                document.getElementById('modalAlert').innerHTML = '';
                this.showModal();
            }

            showModal() {
                document.getElementById('deviceModal').style.display = 'block';
            }

            closeModal() {
                document.getElementById('deviceModal').style.display = 'none';
                document.getElementById('deviceForm').reset();
                document.getElementById('modalAlert').innerHTML = '';
                this.editingDeviceId = null;
            }

            closeDetailsModal() {
                document.getElementById('deviceDetailsModal').style.display = 'none';
            }

            closeDeleteModal() {
                document.getElementById('deleteConfirmModal').style.display = 'none';
                this.deletingDeviceId = null;
            }
            
            logout() {
                localStorage.removeItem('microshare_session_token');
                localStorage.removeItem('user_info');
                localStorage.removeItem('api_base');
                this.redirectToLogin();
            }
            
            initializeEventListeners() {
                // Search and filters
                document.getElementById('searchInput').addEventListener('input', () => this.applyFilters());
                document.getElementById('customerFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('typeFilter').addEventListener('change', () => this.applyFilters());

                // Stat card filters
                document.querySelectorAll('.stat-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const filterType = card.getAttribute('data-filter-type');
                        this.applyStatCardFilter(filterType);
                    });
                });

                // Action buttons
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadDevices());
                document.getElementById('addDeviceBtn').addEventListener('click', () => this.showAddDeviceModal());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportDevices());
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());

                // Modal controls
                document.querySelector('.close').addEventListener('click', () => this.closeModal());
                document.getElementById('cancelBtn').addEventListener('click', () => this.closeModal());
                
                // Form submission
                document.getElementById('deviceForm').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const formData = new FormData(e.target);
                    const deviceData = Object.fromEntries(formData.entries());

                    // Remove hidden device_id if it's empty (for new devices)
                    if (!deviceData.device_id) {
                        delete deviceData.device_id;
                    }

                    try {
                        await this.saveDevice(deviceData);
                    } catch (error) {
                        // Error already handled in saveDevice method
                    }
                });
                
                // Close modals when clicking outside
                window.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('deviceModal')) {
                        this.closeModal();
                    }
                    if (e.target === document.getElementById('deviceDetailsModal')) {
                        this.closeDetailsModal();
                    }
                    if (e.target === document.getElementById('deleteConfirmModal')) {
                        this.closeDeleteModal();
                    }
                });
            }

            // Async operation status polling
            async pollOperationStatus(operationId, operationType) {
                const maxPolls = 30; // Max 30 polls (5 minutes with 10s intervals)
                let pollCount = 0;

                const poll = async () => {
                    if (pollCount >= maxPolls) {
                        this.showAlert(`Operation ${operationId} timed out after 5 minutes. Please check manually.`, 'warning');
                        return;
                    }

                    try {
                        const response = await this.makeAuthenticatedRequest(
                            `${this.baseURL}/api/v1/operations/${operationId}`
                        );

                        if (response && response.ok) {
                            const status = await response.json();

                            if (status.status === 'completed') {
                                this.showAlert(`Device ${operationType} completed successfully!`, 'success');

                                // Clear from deletion tracking if it was a delete operation
                                if (operationType === 'delete' && status.device_id) {
                                    this.devicesBeingDeleted.delete(status.device_id);
                                }

                                // Refresh the device list to show final state
                                this.loadDevices();
                                return;
                            } else if (status.status === 'failed') {
                                this.showAlert(`Device ${operationType} failed: ${status.error}`, 'error');

                                // Clear from deletion tracking if it was a delete operation that failed
                                if (operationType === 'delete' && status.device_id) {
                                    this.devicesBeingDeleted.delete(status.device_id);
                                    this.renderDeviceTable(); // Re-render to remove strikethrough
                                }
                                return;
                            } else if (status.status === 'processing') {
                                // Continue polling
                                pollCount++;
                                setTimeout(poll, 10000); // Poll every 10 seconds
                            }
                        } else {
                            pollCount++;
                            setTimeout(poll, 10000);
                        }
                    } catch (error) {
                        pollCount++;
                        if (pollCount < maxPolls) {
                            setTimeout(poll, 10000);
                        }
                    }
                };

                // Start polling after 5 seconds
                setTimeout(poll, 5000);
            }
        }
        
        // Initialize dashboard
        const dashboard = new DashboardController();
    </script>
</body>
</html>
